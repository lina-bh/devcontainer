on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 0 1,15 * *" # midnight on the 1st and 15th
  workflow_dispatch:
jobs:
  build:
    name: Build and push ghcr.io/${{ github.repository }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io/${{ github.repository_owner }}
      NAME: ghcr.io/${{ github.repository }}
    steps:
    - name: Log in to ghcr.io
      uses: redhat-actions/podman-login@v1
      with:
        username: ${{ github.actor }}
        password: ${{ github.token }}
        registry: ${{ env.REGISTRY }}
    - uses: actions/checkout@v4
    - name: Build ghcr.io/${{ github.repository }}:latest
      run: make build NAME=${{ env.NAME }} EXTRA_BUILD_ARGS='--label=org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }} --build-arg=CTAN_MIRROR=http://mirror.ctan.org'
    - name: Tag ${{ github.sha }}
      run: make tag NAME=${{ env.NAME }} TAG=$(git rev-parse HEAD)
    - name: Push latest
      run: make push NAME=${{ env.NAME }}
    - name: Push ${{ github.sha }}
      run: make push NAME=${{ env.NAME }} TAG=$(git rev-parse HEAD)
